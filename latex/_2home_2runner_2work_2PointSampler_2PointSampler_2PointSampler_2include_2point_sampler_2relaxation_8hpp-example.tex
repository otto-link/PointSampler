\doxysection{/home/runner/work/\+Point\+Sampler/\+Point\+Sampler/\+Point\+Sampler/include/point\+\_\+sampler/relaxation.\+hpp}
\hypertarget{_2home_2runner_2work_2PointSampler_2PointSampler_2PointSampler_2include_2point_sampler_2relaxation_8hpp-example}{}\label{_2home_2runner_2work_2PointSampler_2PointSampler_2PointSampler_2include_2point_sampler_2relaxation_8hpp-example}Relax a point set using a k-\/nearest neighbor repulsion algorithm with a KD-\/tree.

Relax a point set using a k-\/nearest neighbor repulsion algorithm with a KD-\/tree.\+This function performs iterative relaxation on a set of N-\/dimensional points by pushing each point away from its nearest neighbors. It uses a KD-\/tree for efficient neighbor lookup. The goal is to reduce clustering and obtain a more uniform or blue-\/noise-\/like distribution.

Each point is offset based on inverse-\/distance-\/weighted repulsion from its k-\/nearest neighbors, normalized and scaled by a step size. The point set is updated over a number of iterations.


\begin{DoxyTemplParams}{Template Parameters}
{\em T} & Numeric type for coordinates (e.\+g., float or double). \\
\hline
{\em N} & Number of dimensions.\\
\hline
\end{DoxyTemplParams}

\begin{DoxyParams}[1]{Parameters}
\mbox{\texttt{ in,out}}  & {\em points} & The point set to relax. This vector will be modified in place. \\
\hline
\mbox{\texttt{ in}}  & {\em k\+\_\+neighbors} & Number of neighbors to consider (default is 8). \\
\hline
\mbox{\texttt{ in}}  & {\em step\+\_\+size} & How far to move a point per iteration (default is 0.\+1). \\
\hline
\mbox{\texttt{ in}}  & {\em iterations} & Number of relaxation iterations (default is 10).\\
\hline
\end{DoxyParams}
\begin{DoxyNote}{Note}
The KD-\/tree is rebuilt on each iteration to reflect the updated positions.
\end{DoxyNote}

\begin{DoxyCode}{0}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <\mbox{\hyperlink{relaxation_8hpp}{point\_sampler/relaxation.hpp}}>}}
\DoxyCodeLine{}
\DoxyCodeLine{std::vector<Point<float,\ 2>>\ pts\ =\ generate\_random\_points<float,\ 2>(}
\DoxyCodeLine{\ \ \ \ 1000,\ \{\ \{\ \{0.f,\ 1.f\},\ \{0.f,\ 1.f\}\ \}\ \},\ 42);}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{comment}{//\ Apply\ 10\ iterations\ of\ relaxation\ relaxation\_ktree<float,\ 2>(pts,\ 8,\ 0.1f,}}
\DoxyCodeLine{10);}

\end{DoxyCode}
\hypertarget{relaxation.hpp_autotoc_md0}{}\doxysubsubsubsection{\texorpdfstring{How it works\+:}{How it works:}}\label{relaxation.hpp_autotoc_md0}

\begin{DoxyItemize}
\item For each point\+:
\begin{DoxyItemize}
\item Find its {\ttfamily k\+\_\+neighbors} nearest neighbors using a KD-\/tree.
\item Compute offset vectors from the current point to each neighbor.
\item Weight the vectors by the inverse square distance (stronger push from closer neighbors).
\item Accumulate the offset, normalize, and scale by {\ttfamily step\+\_\+size}.
\item Apply the movement to each point.
\end{DoxyItemize}
\item Repeat for {\ttfamily iterations} steps.
\end{DoxyItemize}


\begin{DoxyCodeInclude}{0}
\DoxyCodeLine{\textcolor{comment}{/*\ Copyright\ (c)\ 2025\ Otto\ Link.\ Distributed\ under\ the\ terms\ of\ the\ GNU\ General}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ Public\ License.\ The\ full\ license\ is\ in\ the\ file\ LICENSE,\ distributed\ with}}
\DoxyCodeLine{\textcolor{comment}{\ \ \ this\ software.\ */}}
\DoxyCodeLine{\textcolor{preprocessor}{\#pragma\ once}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <cstddef>}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ <optional>}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{nanoflann__adaptator_8hpp}{point\_sampler/internal/nanoflann\_adaptator.hpp}}"{}}}
\DoxyCodeLine{\textcolor{preprocessor}{\#include\ "{}\mbox{\hyperlink{point_8hpp}{point\_sampler/point.hpp}}"{}}}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{namespace\ }\mbox{\hyperlink{namespaceps}{ps}}}
\DoxyCodeLine{\{}
\DoxyCodeLine{}
\DoxyCodeLine{\textcolor{keyword}{template}\ <\textcolor{keyword}{typename}\ T,\ \textcolor{keywordtype}{size\_t}\ N>}
\DoxyCodeLine{\textcolor{keywordtype}{void}\ \mbox{\hyperlink{namespaceps_aed8a3217a801c5b5706f4bcc3306bb18}{relaxation\_ktree}}(std::vector<Point<T,\ N>>\ \&points,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ k\_neighbors\ =\ 8,}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ T\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ step\_size\ =\ T(0.1),}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \textcolor{keywordtype}{size\_t}\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ iterations\ =\ 10)}
\DoxyCodeLine{\{}
\DoxyCodeLine{\ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ iter\ =\ 0;\ iter\ <\ iterations;\ ++iter)}
\DoxyCodeLine{\ \ \{}
\DoxyCodeLine{\ \ \ \ PointCloudAdaptor<T,\ N>\ adaptor(points);}
\DoxyCodeLine{\ \ \ \ KDTree<T,\ N>\ \ \ \ \ \ \ \ \ \ \ \ index(N,\ adaptor);}
\DoxyCodeLine{\ \ \ \ index.buildIndex();}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ std::vector<Point<T,\ N>>\ new\_points\ =\ points;}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ i\ =\ 0;\ i\ <\ points.size();\ ++i)}
\DoxyCodeLine{\ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ \&p\ =\ points[i];}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ std::vector<size\_t>\ ret\_indexes(k\_neighbors\ +\ 1);}
\DoxyCodeLine{\ \ \ \ \ \ std::vector<T>\ \ \ \ \ \ out\_dists\_sqr(k\_neighbors\ +\ 1);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ nanoflann::KNNResultSet<T>\ result\_set(k\_neighbors\ +\ 1);}
\DoxyCodeLine{\ \ \ \ \ \ result\_set.init(ret\_indexes.data(),\ out\_dists\_sqr.data());}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ std::array<T,\ N>\ query;}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ d\ =\ 0;\ d\ <\ N;\ ++d)}
\DoxyCodeLine{\ \ \ \ \ \ \ \ query[d]\ =\ p[d];}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ index.findNeighbors(result\_set,\ query.data(),\ nanoflann::SearchParameters());}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ Point<T,\ N>\ offset\{\};}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{comment}{//\ skip\ self\ at\ j=0}}
\DoxyCodeLine{\ \ \ \ \ \ \textcolor{keywordflow}{for}\ (\textcolor{keywordtype}{size\_t}\ j\ =\ 1;\ j\ <\ result\_set.size();\ ++j)}
\DoxyCodeLine{\ \ \ \ \ \ \{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{const}\ \textcolor{keyword}{auto}\ \&q\ =\ points[ret\_indexes[j]];}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{keyword}{auto}\ \ \ \ \ \ \ \ delta\ =\ p\ -\/\ q;}
\DoxyCodeLine{\ \ \ \ \ \ \ \ \textcolor{comment}{//\ avoid\ div\ by\ 0}}
\DoxyCodeLine{\ \ \ \ \ \ \ \ T\ dist\_sq\ =\ \mbox{\hyperlink{namespaceps_a7c3e161560ad3000aa4e2218291b169c}{length\_squared}}(delta)\ +\ T(1e-\/6);}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ \ \ offset\ =\ offset\ +\ delta\ /\ dist\_sq;}
\DoxyCodeLine{\ \ \ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ \ \ new\_points[i]\ =\ p\ +\ \mbox{\hyperlink{namespaceps_a7de6090e2c8291401816be9bc6cda914}{normalized}}(offset)\ *\ step\_size;}
\DoxyCodeLine{\ \ \ \ \}}
\DoxyCodeLine{}
\DoxyCodeLine{\ \ \ \ points\ =\ std::move(new\_points);}
\DoxyCodeLine{\ \ \}}
\DoxyCodeLine{\}}
\DoxyCodeLine{}
\DoxyCodeLine{\}\ \textcolor{comment}{//\ namespace\ ps}}

\end{DoxyCodeInclude}
 